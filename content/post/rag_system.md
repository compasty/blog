---
date: '2025-09-15T17:20:31+08:00'
draft: false
title: 'Rag_system'
categories:
  - tech
keywords:
  - LLM
  - RAG
tags:
  - RAG
  - LLM
---

# RAG

RAG是Retrieval-Augmented Generation的缩写，是一种基于LLM的生成模型，它的核心思想是将LLM与外部知识库进行结合，以实现更准确、更丰富的生成结果。

## 工作原理详解

RAG系统的工作原理涉及多个关键技术组件

### 1. 文档处理与分块 (Chunking)

**分块策略：**
- **固定大小分块**：按照固定字符数或token数进行分割
- **语义分块**：基于句子边界、段落结构进行智能分割
- **重叠分块**：相邻块之间保持重叠，避免上下文丢失
- **层次分块**：针对不同内容类型采用不同粒度

**优化考虑：**
- **块大小平衡**：平衡上下文完整性和检索精度
- **结构保持**：保持文档的语义结构和逻辑连贯性
- **元数据保留**：保存标题、章节等结构信息用于增强检索

### 2. 嵌入模型 (Embedding Models)

**嵌入技术：**
- **稠密嵌入**：将文本映射到高维稠密向量空间
  - BERT系列：基于Transformer的上下文相关嵌入
  - Sentence-BERT：专门为句子相似度优化的模型
  - E5、BGE等最新嵌入模型

- **稀疏嵌入**：基于词频的稀疏向量表示
  - BM25：经典的词频-逆文档频率算法
  - SPLADE：学习得到的稀疏表示

**嵌入优化：**
- **领域适应**：在特定领域数据上微调嵌入模型
- **多语言支持**：支持跨语言的语义检索
- **维度选择**：平衡表示能力和计算效率

### 3. 向量数据库 (Vector Databases)

**核心功能：**
- **高效相似度搜索**：基于近似最近邻(ANN)算法
- **大规模扩展**：支持十亿级向量的存储和检索
- **实时更新**：支持动态添加、删除和更新向量

**主流向量数据库：**
- **FAISS**：Facebook开源的高性能向量搜索库
- **Pinecone**：全托管的云原生向量数据库
- **Weaviate**：开源的向量搜索引擎
- **Milvus**：开源的向量数据库，支持多种索引类型
- **Qdrant**：Rust编写的高性能向量数据库

**索引算法：**
- **HNSW (Hierarchical Navigable Small World)**：基于图的索引
- **IVF (Inverted File)**：基于聚类的倒排索引
- **LSH (Locality Sensitive Hashing)**：局部敏感哈希
- **PQ (Product Quantization)**：乘积量化压缩

### 4. 检索机制 (Retrieval Mechanisms)

**检索策略：**
- **稠密检索**：基于语义相似度的向量搜索
- **稀疏检索**：基于关键词匹配的传统搜索
- **混合检索**：结合稠密和稀疏检索的优势
- **多向量检索**：使用多个嵌入模型提高召回率

**检索优化：**
- **查询重写**：扩展或优化用户查询以提高检索效果
- **伪相关反馈**：利用初始检索结果扩展查询
- **多阶段检索**：粗排+精排的两阶段检索策略
- **个性化检索**：基于用户历史调整检索结果

### 5. 重排序 (Re-ranking)

**重排序模型：**
- **交叉编码器**：同时编码查询和文档的精细模型
- **ColBERT**：轻量级的延迟交互模型
- **MonoT5/T5**：基于T5的排序模型
- **RankGPT**：基于GPT的列表式排序

**重排序策略：**
- **多模型融合**：结合多个排序模型的结果
- **特征工程**：利用文档特征增强排序效果
- **在线学习**：基于用户反馈持续优化排序

### 6. 上下文构建 (Context Construction)

**构建策略：**
- **选择性包含**：基于相关性分数筛选文档片段
- **结构化组织**：按主题、时间等维度组织检索结果
- **摘要生成**：为长文档生成简洁摘要
- **多模态整合**：整合文本、表格、图像等不同模态

**优化技术：**
- **上下文压缩**：减少冗余信息，优化token使用
- **动态选择**：根据查询复杂度调整上下文大小
- **重要性加权**：为不同信息源分配不同权重

### 7. 生成优化 (Generation Optimization)

**提示工程：**
- **角色定义**：为模型设定专业角色和背景
- **任务说明**：明确生成任务的要求和约束
- **示例学习**：提供few-shot示例引导生成
- **格式规范**：指定输出格式和结构要求

**质量控制：**
- **事实核查**：验证生成内容与检索信息的一致性
- **幻觉检测**：识别和纠正模型编造的信息
- **引用标注**：为生成内容提供可追溯的信息源
- **置信度评估**：评估模型对生成内容的确定程度

### 8. 系统架构优化

**性能优化：**
- **缓存策略**：缓存常见查询的检索和生成结果
- **预计算**：预先计算和存储文档嵌入
- **并行处理**：并行执行检索、重排序和生成
- **增量更新**：支持知识库的增量更新和维护

**可扩展性设计：**
- **微服务架构**：将不同组件解耦为独立服务
- **负载均衡**：在多个检索节点间分配查询
- **数据分片**：将大规模数据分布到多个节点
- **CDN集成**：利用CDN加速静态资源访问

通过这些核心技术的协同工作，RAG系统能够实现高效、准确的知识检索和生成，为各种应用场景提供强大的问答和知识服务能力。

## 工程示例

