---
date: '2025-04-02T14:56:52+08:00'
draft: false
title: '微信小程序开发记录'
categories:
  - tech
keywords:
  - 微信小程序
tags:
  - 微信小程序
---

# 基础

## 与网页开发的区别

开发语言都是javascript。

​网页开发中， 渲染任务和脚本任务是互斥的，而在小程序中二者是**分别运行在不同的线程**。小程序的逻辑层和渲染层是分开的，逻辑层运行在不同于渲染层的独立 JS 运行时中，因此并不能直接使用 DOM API 和 BOM API。这一区别导致了前端开发非常熟悉的一些库，例如 jQuery、 Zepto 等，在小程序中是无法运行的。同时逻辑层的 JS 运行时与 NodeJS 环境也不尽相同，所以一些 NPM 的包在小程序中也是无法运行的。

| 运行环境 | 逻辑环境 | 渲染层 |
|----------|----------|----------|
| iOS    | JavascriptCore   | WKWebView   |
| 安卓    | V8   |   chromium定制内核 |
| 小程序开发者工具    | NWJS   |   Chrome WebView |


## 宿主环境

微信客户端native给小程序所提供的环境为**宿主环境**。小程序借助宿主环境提供的能力，可以完成许多普通网页无法完成的功能。

小程序的渲染层和逻辑层分别由2个线程管理：渲染层的界面使用了WebView 进行渲染；逻辑层采用JsCore线程运行JS脚本。一个小程序存在多个界面，所以渲染层存在多个WebView线程，这两个线程的通信会经由微信客户端做中转，逻辑层发送网络请求也经由Native转发，小程序的通信模型下图所示。

![MiniApp Architecture](/images/tech/wechat_transport.png)

## 代码构成

小程序中包含四类文件：

1. `.json` 后缀的 JSON 配置文件
2. `.wxml` 后缀的 WXML 模板文件
3. `.wxss` 后缀的 WXSS 样式文件
4. `.js` 后缀的 JS 脚本逻辑文件

### JSON配置文件

在小程序中，JSON扮演的是静态配置的角色。在项目的根目录有一个`app.json`和 `project.config.json`，此外在`pages/logs`目录下还有一个`logs.json`。

**app.json**
`app.json`是当前小程序的全局配置，包括了小程序的所有页面路径、界面表现、网络超时时间、底部 tab 等。

```json
{
  "pages":[
    "pages/index/index",
    "pages/logs/logs"
  ],
  "window":{
    "backgroundTextStyle":"light",
    "navigationBarBackgroundColor": "#fff",
    "navigationBarTitleText": "Weixin",
    "navigationBarTextStyle":"black"
  }
}
```

配置各个项的含义:

1. `pages`字段 —— 用于描述当前小程序所有页面路径，这是为了让微信客户端知道当前你的小程序页面定义在哪个目录。
2. `window`字段 —— 定义小程序所有页面的顶部背景颜色，文字颜色定义等。


**工具配置 project.config.json**:

存放针对工具的个性化配置，其中会包括编辑器的颜色、代码上传时自动压缩等等一系列选项，保证迁移开发工具或者环境时保持一致性。

**页面配置 page.json**
这里的`page.json`其实用来表示`pages/logs`目录下的`logs.json`这类和小程序页面相关的配置。

如果你整个小程序的风格是蓝色调，那么你可以在 app.json 里边声明顶部颜色是蓝色即可。实际情况可能不是这样，可能你小程序里边的每个页面都有不一样的色调来区分不同功能模块，因此我们提供了`page.json`，让开发者可以独立定义每个页面的一些属性，例如刚刚说的顶部颜色、是否允许下拉刷新等等。

### WXML模板

WXML类似html, 用来描述页面的结构，也是由标签、属性等等构成。但是也有很多不一样的地方。

1. 标签名字不一样：小程序的 WXML 用的标签是`view`,`button`,`text`等等，这些标签就是小程序给开发者包装好的基本能力，我们还提供了地图、视频、音频等等组件能力。
2. 支持`wx:if`等特殊的属性以及`{{ }}`这样的表达式

```xml
<view class="container">
  <view class="userinfo">
    <button wx:if="{{!hasUserInfo && canIUse}}"> 获取头像昵称 </button>
    <block wx:else>
      <image src="{{userInfo.avatarUrl}}" background-size="cover"></image>
      <text class="userinfo-nickname">{{userInfo.nickName}}</text>
    </block>
  </view>
  <view class="usermotto">
    <text class="user-motto">{{motto}}</text>
  </view>
</view>
```

### WXSS样式

WXSS具有CSS大部分的特性，做了扩充和修改。

1. 新增了尺寸单位: WXSS 在底层支持新的尺寸单位`rpx`，解决不同宽度和设备像素比换算的烦恼
2. 提供了全局的样式和局部样式: `app.wxss`作为全局样式，会作用于当前小程序的所有页面，局部页面样式`page.wxss`仅对当前页面生效
3. 仅支持部分`CSS`选择器

### JS逻辑交互

可以在 JS 中调用小程序提供的丰富的 API，利用这些 API 可以很方便的调起微信提供的能力，例如获取用户信息、本地存储、微信支付等。

```javascript
Page({
  getUserProfile(e) {
    // 推荐使用wx.getUserProfile获取用户信息，开发者每次通过该接口获取用户个人信息均需用户确认，开发者妥善保管用户快速填写的头像昵称，避免重复弹窗
    wx.getUserProfile({
      desc: '展示用户信息', // 声明获取用户个人信息后的用途，后续会展示在弹窗中，请谨慎填写
      success: (res) => {
        console.log(res)
        this.setData({
          userInfo: res.userInfo,
          hasUserInfo: true
        })
      }
    })
  },
})
```

## 启动和渲染流程

微信客户端在打开小程序之前，会把整个小程序的代码包下载到本地。紧接着通过`app.json`的`pages`字段就可以知道你当前小程序的所有页面路径, 如下面的配置代表有两个页面，分别位于`pages/index/index`和`pages/logs/logs`。而在`pages`中的第一个页面就是打开小程序看到的第一个页面。

```json
{
  "pages":[
    "pages/index/index",
    "pages/logs/logs"
  ]
}
```

小程序启动之后，在`app.js`定义的`App`实例的`onLaunch`回调会被执行。整个小程序只有一个`App` 实例，是全部页面共享的。

```javascript
App({
  onLaunch: function () {
    // 小程序启动之后 触发
  }
})
```

一个页面包含4种文件，以`logs`页面为例，微信客户端会先根据`logs.json`配置生成一个界面，顶部的颜色和文字你都可以在这个 json 文件里边定义好。紧接着客户端就会装载这个页面的 WXML 结构和 WXSS 样式。最后客户端会装载`logs.js`。

```javascript
Page({
  data: { // 参与页面渲染的数据
    logs: []
  },
  onLoad: function () {
    // 页面渲染后 执行
  }
})
```

`Page`是一个页面构造器，这个构造器就生成了一个页面。在生成页面的时候，小程序框架会把`data`数据和`index.wxml`一起渲染出最终的结构

## 组件

小程序提供了丰富的基础组件给开发者，开发者可以像搭积木一样，组合各种组件拼合成自己的小程序。在小程序里边，你只需要在 WXML 写上对应的组件标签名字就可以把该组件显示在界面上，例如，你需要在界面上显示地图:

```xml
<map bindmarkertap="markertap" longitude="广州经度" latitude="广州纬度"></map>
```

也可以通过`style`或者`class`来控制组件的外层样式，以便适应你的界面宽度高度等等。

## API

为了让开发者可以很方便的调起微信提供的能力，例如获取用户信息、微信支付等等，小程序提供了很多 API 给开发者去使用。例如获取用户位置信息和调用微信扫一扫：

```javascript
wx.getLocation({
  type: 'wgs84',
  success: (res) => {
    var latitude = res.latitude // 纬度
    var longitude = res.longitude // 经度
  }
})
wx.scanCode({
  success: (res) => {
    console.log(res)
  }
})
```

> 多数 API 的回调都是异步，你需要处理好代码逻辑的异步问题

## 版本管理&发布

### 小程序的版本

一般的软件开发流程，开发者编写代码自测开发版程序，直到程序达到一个稳定可体验的状态时，开发者会把这个体验版本给到产品经理和测试人员进行体验测试，最后修复完程序的Bug后发布供外部用户正式使用。小程序的版本根据这个流程设计了小程序版本的概念。

1. **开发版本**：使用开发者工具，可将代码上传到开发版本中。 开发版本只保留每人最新的一份上传的代码。点击提交审核，可将代码提交审核。开发版本可删除，不影响线上版本和审核中版本的代码。
2. **体验版本**: 可以选择某个开发版本作为体验版，并且选取一份体验版。
3. **审核中版本**: 只能有一份代码处于审核中。有审核结果后可以发布到线上，也可直接重新提交审核，覆盖原审核版本。
4. **线上版本**: 线上所有用户使用的代码版本，该版本代码在新版本代码发布后被覆盖更新。

### 发布上线

一个小程序从开发完到上线一般要经过 预览-> 上传代码 -> 提交审核 -> 发布等步骤。

**预览**

使用开发者工具可以预览小程序，帮助开发者检查小程序在移动客户端上的真实表现。点击开发者工具顶部操作栏的预览按钮，开发者工具会自动打包当前项目，并上传小程序代码至微信的服务器，成功之后会在界面上显示一个二维码，扫码即可看到小程序在手机客户端上的真实表现。

**上传代码**

上传代码是用于提交体验或者审核使用的。点击开发者工具顶部操作栏的上传按钮，填写版本号以及项目备注，需要注意的是，这里版本号以及项目备注是为了方便管理员检查版本使用的，开发者可以根据自己的实际要求来填写这两个字段。

上传成功之后，登录小程序管理后台 - 版本管理 - 开发版本 就可以找到刚提交上传的版本了。可以将这个版本设置 *体验版* 或者是 *提交审核*。

**提交审核**

在开发版本的列表中，点击 *提交审核* 按照页面提示，填写相关的信息，即可以将小程序提交审核。

**发布**

审核通过之后，管理员的微信中会收到小程序通过审核的通知。此时可以点击发布，即可发布小程序。小程序提供了两种发布模式：全量发布和分阶段发布（即灰度发布）。